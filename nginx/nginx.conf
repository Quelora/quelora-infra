events {}

http {
    include       mime.types;
    default_type  application/octet-stream;
 
    # =====================================================
    # COMPRESIÓN GZIP (WASM + JS + CSS)
    # =====================================================
    gzip on;
    gzip_comp_level 6;
    gzip_min_length 1024;
    gzip_vary on;
    gzip_proxied any;

    gzip_types
        text/plain
        text/css
        application/javascript
        application/json
        application/wasm
        image/svg+xml;

    # =====================================================
    # SERVER : NODE DEMO (443)
    # =====================================================
    server {
        listen 443 ssl;
        server_name _;

        ssl_certificate     /etc/nginx/certs/quelora.localhost.ar.pem;
        ssl_certificate_key /etc/nginx/certs/quelora.localhost.ar-key.pem;

        location / {
            proxy_pass http://node-demo:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }

    # =====================================================
    # SERVER : QUELORA API + ASSETS (444)
    # =====================================================
    server {
        listen 444 ssl;
        server_name _;

        ssl_certificate     /etc/nginx/certs/quelora.localhost.ar.pem;
        ssl_certificate_key /etc/nginx/certs/quelora.localhost.ar-key.pem;

        # --------------------
        # STATIC ASSETS
        # --------------------
        location /assets/ {
            alias /usr/src/app/packages/quelora-public-api/public/assets/;
            try_files $uri $uri/ =404;

            expires 30d;
            add_header Cache-Control "public, immutable";

            access_log off;
        }

        # --------------------
        # SSE (SIN COMPRESIÓN)
        # --------------------
        location /notifications/stream {
            proxy_pass http://quelora-api:3000;

            proxy_buffering off;
            proxy_cache off;

            proxy_http_version 1.1;
            proxy_set_header Connection '';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            proxy_read_timeout 24h;
            proxy_send_timeout 24h;

            gzip off;
        }

        # --------------------
        # WEBSOCKET LIVE
        # --------------------
        location /ws/live {
            proxy_pass http://quelora-api:3000/ws/live;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --------------------
        # API DEFAULT
        # --------------------
        location / {
            # 1. Headers de Geolocalización
            add_header X-Server-Country "AR" always;
            add_header X-Server-Region  "LATAM_SOUTH" always;
            add_header Alt-Svc 'h3=":443"; ma=86400' always;

            # 2. CORS
            proxy_hide_header Access-Control-Expose-Headers;
            add_header Access-Control-Expose-Headers "X-Captcha-Token, X-Cache-Compressor, X-Cache-App, X-Ip, X-Country, X-Country-Code, X-Region-Code, X-Region, X-City, X-Lat, X-Lon, X-Server-Country, X-Server-Region, , X-Cache-Bin, X-Resilience-Scope, X-Quelora-Sidecar," always;

            proxy_pass http://quelora-api:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }

    # =====================================================
    # SERVER : DASHBOARD API (446)
    # =====================================================
    server {
        listen 446 ssl;
        server_name _;

        ssl_certificate     /etc/nginx/certs/quelora.localhost.ar.pem;
        ssl_certificate_key /etc/nginx/certs/quelora.localhost.ar-key.pem;

        client_max_body_size 25m;

        location / {
            proxy_pass http://quelora-dashboard-api:3010;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }

    # =====================================================
    # SERVER : DASHBOARD FRONT + WS (445)
    # =====================================================
    server {
        listen 445 ssl;
        server_name _;

        ssl_certificate     /etc/nginx/certs/quelora.localhost.ar.pem;
        ssl_certificate_key /etc/nginx/certs/quelora.localhost.ar-key.pem;

        location / {
            proxy_pass http://dashboard:3002;
            proxy_http_version 1.1;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /ws {
            proxy_pass http://dashboard:3002/ws;
            proxy_http_version 1.1;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }
    }

    # =====================================================
    # REDIRECT HTTP → HTTPS
    # =====================================================
    server {
        listen 80;
        return 301 https://$host$request_uri;
    }
}
