events {
    worker_connections 1024;
}

http {
    # Ocultar Server
    server_tokens off;

    # GZIP
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_comp_level 6;
    gzip_vary on;
    gzip_min_length 1100;
    gzip_buffers 4 32k;

    # DOS - Configurado para 300 request por segundo y 20 megas. El filtro se aplica por IP
    limit_req_zone $binary_remote_addr zone=one:20m rate=300r/s;

    # Anti-scraping
    map $http_user_agent $bad_agent {
        default 0;
        ~*(wget|curl|scrapy|nmap|nikto|admin|sqlmap|burp|nessus|metasploit|dirbuster) 1;
    }

    server {
        listen 80;
        listen [::]:80;
        server_name quelora.org www.quelora.org api.quelora.org dashboard.quelora.org htop.quelora.org;

        add_header X-Robots-Tag "noindex, nofollow" always;

        # üîê Permitir verificaci√≥n de Let's Encrypt sin redirigir a HTTPS
        location ^~ /.well-known/acme-challenge/ {
            root /etc/nginx/certs/webroot;
            allow all;
        }
    }


    # Servidor principal (www)
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name quelora.org www.quelora.org;

        ssl_certificate     /etc/letsencrypt/live/quelora.org/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/quelora.org/privkey.pem;
        
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 1d;
        ssl_session_tickets off;
        ssl_stapling_verify on;

        client_max_body_size 30M;

        # Bloqueo de agentes maliciosos
        if ($bad_agent) {
            return 401;
        }

        # Limitar el n√∫mero de peticiones por segundo
        limit_req zone=one burst=50 nodelay;

        # Bloqueo de rutas peligrosas
        location ~* ^/(mgmt|cgi-bin|\.git|\.env|wp-admin) {
            return 401;
        }

        location / {
          proxy_pass http://node-demo:3001;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
        }
    }

    # API subdominio
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name api.quelora.org;

        ssl_certificate     /etc/letsencrypt/live/quelora.org/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/quelora.org/privkey.pem;
        
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 1d;
        ssl_session_tickets off;
        ssl_stapling_verify on;

        client_max_body_size 30M;

        # Bloqueo de agentes maliciosos
        if ($bad_agent) {
            return 401;
        }

        # Limitar el n√∫mero de peticiones por segundo
        limit_req zone=one burst=50 nodelay;

        # Bloqueo de rutas peligrosas
        location ~* ^/(mgmt|cgi-bin|\.git|\.env|wp-admin) {
            return 401;
        }

        location / {
          proxy_pass http://quelora:3000;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
        }
    }

    # Dashboard subdominio
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name dashboard.quelora.org;

        ssl_certificate     /etc/letsencrypt/live/quelora.org/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/quelora.org/privkey.pem;

        
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 1d;
        ssl_session_tickets off;
        ssl_stapling_verify on;

        client_max_body_size 30M;

        # Bloqueo de agentes maliciosos
        if ($bad_agent) {
            return 401;
        }

        # Limitar el n√∫mero de peticiones por segundo
        limit_req zone=one burst=50 nodelay;

        # Bloqueo de rutas peligrosas
        location ~* ^/(mgmt|cgi-bin|\.git|\.env|wp-admin) {
            return 401;
        }

        location / {
          proxy_pass http://dashboard:80;
          proxy_http_version 1.1;
          proxy_cache off;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}